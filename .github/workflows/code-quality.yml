name: ðŸ“ Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  linting:
    name: ðŸ” Linting & Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” Run ESLint
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint
        continue-on-error: false

      - name: ðŸ“¤ Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30

      - name: ðŸ“Š ESLint annotations
        if: always()
        uses: ataylorme/eslint-annotate-action@v2
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          report-json: "eslint-report.json"

      - name: âœ¨ Check Prettier formatting
        run: |
          echo "âœ¨ Checking code formatting with Prettier..."
          if command -v prettier &> /dev/null; then
            npx prettier --check "src/**/*.{ts,js,json}" || {
              echo "âŒ Code is not properly formatted"
              echo "ðŸ”§ Run 'npx prettier --write \"src/**/*.{ts,js,json}\"' to fix formatting"
              exit 1
            }
            echo "âœ… Code formatting is correct"
          else
            echo "âš ï¸ Prettier not found, skipping format check"
          fi

  type-coverage:
    name: ðŸŽ¯ TypeScript Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸŽ¯ Type coverage analysis
        run: |
          echo "ðŸŽ¯ Analyzing TypeScript type coverage..."
          
          # Install type coverage tool
          npm install -g typescript-coverage-report
          
          # Generate type coverage report
          npx typescript-coverage-report --threshold 85 --outputDir type-coverage-report
          
          # Extract coverage percentage
          COVERAGE=$(npx typescript-coverage-report --outputDir /tmp 2>&1 | grep -o '[0-9]\+\.[0-9]\+%' | tail -1)
          echo "ðŸ“Š Type coverage: $COVERAGE"
          
          echo "type-coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload type coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-coverage-report
          path: type-coverage-report/
          retention-days: 30

  test-coverage:
    name: ðŸ§ª Test Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ§ª Run tests with coverage
        run: |
          echo "ðŸ§ª Running tests with coverage analysis..."
          npm test -- --coverage --coverageReporters=text-lcov --coverageReporters=json --coverageReporters=html
        env:
          NODE_ENV: test

      - name: ðŸ“Š Coverage summary
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "ðŸ“Š Coverage Summary:"
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('ðŸ“ˆ Lines:', total.lines.pct + '%');
              console.log('ðŸŒŸ Functions:', total.functions.pct + '%');
              console.log('ðŸ”€ Branches:', total.branches.pct + '%');
              console.log('ðŸ“„ Statements:', total.statements.pct + '%');
              
              // Check thresholds
              const thresholds = { lines: 80, functions: 80, branches: 70, statements: 80 };
              let failed = false;
              
              Object.keys(thresholds).forEach(key => {
                if (total[key].pct < thresholds[key]) {
                  console.log('âŒ ' + key + ' coverage below threshold:', total[key].pct + '% < ' + thresholds[key] + '%');
                  failed = true;
                }
              });
              
              if (failed) {
                console.log('âŒ Coverage thresholds not met');
                process.exit(1);
              } else {
                console.log('âœ… All coverage thresholds met');
              }
            "
          else
            echo "âš ï¸ Coverage report not found"
          fi

      - name: ðŸ“¤ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ðŸ“Š Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage
          flags: unittests
          name: codecov-${{ github.run_id }}

  code-metrics:
    name: ðŸ“ˆ Code Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“ˆ Analyze code complexity
        run: |
          echo "ðŸ“ˆ Analyzing code complexity..."
          
          # Install complexity analysis tools
          npm install -g complexity-report
          npm install -g jscpd
          
          # Generate complexity report
          echo "ðŸ” Running complexity analysis..."
          complexity-report -o complexity-report.json -f json src/
          
          # Check for high complexity functions
          echo "ðŸ“Š Complexity Summary:"
          node -e "
            const report = require('./complexity-report.json');
            const functions = report.functions || [];
            
            console.log('ðŸ“Š Total functions:', functions.length);
            
            const highComplexity = functions.filter(f => f.complexity.cyclomatic > 10);
            if (highComplexity.length > 0) {
              console.log('âš ï¸ High complexity functions:', highComplexity.length);
              highComplexity.forEach(f => {
                console.log('  -', f.name, '(complexity:', f.complexity.cyclomatic + ')');
              });
            } else {
              console.log('âœ… No high complexity functions found');
            }
            
            const veryHighComplexity = functions.filter(f => f.complexity.cyclomatic > 20);
            if (veryHighComplexity.length > 0) {
              console.log('âŒ Very high complexity functions found - consider refactoring');
              process.exit(1);
            }
          " || echo "âš ï¸ Could not parse complexity report"

      - name: ðŸ“‹ Duplicate code detection
        run: |
          echo "ðŸ“‹ Detecting duplicate code..."
          jscpd src/ --reporters json --output ./jscpd-report.json || echo "âš ï¸ jscpd analysis completed with warnings"
          
          if [ -f jscpd-report.json ]; then
            echo "ðŸ“Š Duplication Summary:"
            node -e "
              try {
                const report = require('./jscpd-report.json');
                const duplicates = report.duplicates || [];
                console.log('ðŸ“Š Total duplicates found:', duplicates.length);
                
                if (duplicates.length > 10) {
                  console.log('âš ï¸ High number of duplicates found - consider refactoring');
                } else if (duplicates.length > 0) {
                  console.log('â„¹ï¸ Some duplicates found - review for potential refactoring opportunities');
                } else {
                  console.log('âœ… No significant code duplication detected');
                }
              } catch (e) {
                console.log('âš ï¸ Could not parse duplication report');
              }
            "
          fi

      - name: ðŸ“¤ Upload code metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics
          path: |
            complexity-report.json
            jscpd-report.json
          retention-days: 30

  dependency-analysis:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“¦ Dependency tree analysis
        run: |
          echo "ðŸ“¦ Analyzing dependency tree..."
          
          # Check for outdated dependencies
          echo "ðŸ” Checking for outdated dependencies..."
          npm outdated --json > outdated-deps.json || echo "âœ… All dependencies are up to date"
          
          if [ -s outdated-deps.json ]; then
            echo "ðŸ“Š Outdated Dependencies Summary:"
            node -e "
              try {
                const outdated = require('./outdated-deps.json');
                const deps = Object.keys(outdated);
                console.log('ðŸ“Š Outdated dependencies:', deps.length);
                
                deps.forEach(dep => {
                  const info = outdated[dep];
                  console.log(\`  - \${dep}: \${info.current} â†’ \${info.latest}\`);
                });
                
                if (deps.length > 20) {
                  console.log('âš ï¸ Many outdated dependencies - consider updating');
                }
              } catch (e) {
                console.log('âœ… All dependencies are up to date');
              }
            "
          fi

      - name: ðŸ“ˆ Bundle size analysis
        run: |
          echo "ðŸ“ˆ Analyzing bundle size..."
          
          # Build the project
          npm run build
          
          # Analyze bundle size
          echo "ðŸ“Š Built file sizes:"
          du -sh dist/* || echo "âš ï¸ Could not analyze dist directory"
          
          # Check for large files
          find dist -type f -size +1M -exec echo "âš ï¸ Large file found: {} ($(du -h {} | cut -f1))" \;

      - name: ðŸ” Unused dependencies check
        run: |
          echo "ðŸ” Checking for unused dependencies..."
          
          # Install depcheck
          npm install -g depcheck
          
          # Run depcheck
          depcheck --json > depcheck-report.json || echo "âœ… No unused dependencies found"
          
          if [ -f depcheck-report.json ]; then
            echo "ðŸ“Š Dependency Check Summary:"
            node -e "
              try {
                const report = require('./depcheck-report.json');
                
                if (report.dependencies && report.dependencies.length > 0) {
                  console.log('âš ï¸ Unused dependencies:', report.dependencies.join(', '));
                } else {
                  console.log('âœ… No unused dependencies found');
                }
                
                if (report.devDependencies && report.devDependencies.length > 0) {
                  console.log('âš ï¸ Unused devDependencies:', report.devDependencies.join(', '));
                } else {
                  console.log('âœ… No unused devDependencies found');
                }
              } catch (e) {
                console.log('âœ… Dependency check completed');
              }
            "
          fi

      - name: ðŸ“¤ Upload dependency analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: |
            outdated-deps.json
            depcheck-report.json
          retention-days: 30

  quality-gate:
    name: ðŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [linting, type-coverage, test-coverage, code-metrics, dependency-analysis]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ðŸšª Quality gate evaluation
        run: |
          echo "## ðŸ“ Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check all job results
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linting & Formatting | ${{ needs.linting.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Coverage | ${{ needs.type-coverage.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Metrics | ${{ needs.code-metrics.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Analysis | ${{ needs.dependency-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Calculate overall quality score
          PASSED=0
          TOTAL=5
          
          [[ "${{ needs.linting.result }}" == "success" ]] && ((PASSED++))
          [[ "${{ needs.type-coverage.result }}" == "success" ]] && ((PASSED++))
          [[ "${{ needs.test-coverage.result }}" == "success" ]] && ((PASSED++))
          [[ "${{ needs.code-metrics.result }}" == "success" ]] && ((PASSED++))
          [[ "${{ needs.dependency-analysis.result }}" == "success" ]] && ((PASSED++))
          
          SCORE=$((PASSED * 100 / TOTAL))
          
          echo "### ðŸ“Š Quality Score: $SCORE% ($PASSED/$TOTAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ $SCORE -ge 80 ]]; then
            echo "### âœ… Quality Gate: **PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality meets the required standards!" >> $GITHUB_STEP_SUMMARY
            exit 0
          elif [[ $SCORE -ge 60 ]]; then
            echo "### âš ï¸ Quality Gate: **WARNING**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality has some issues that should be addressed." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Quality Gate: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality is below acceptable standards." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi