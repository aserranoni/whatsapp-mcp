name: üìè Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '18'

jobs:
  linting:
    name: üîç Linting & Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üîç Run ESLint
        run: |
          echo "üîç Running ESLint..."
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint
        continue-on-error: false

      - name: üì§ Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30

      - name: üìä ESLint annotations
        if: always()
        uses: ataylorme/eslint-annotate-action@v2
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          report-json: "eslint-report.json"

      - name: ‚ú® Check Prettier formatting
        run: |
          echo "‚ú® Checking code formatting with Prettier..."
          if command -v prettier &> /dev/null; then
            npx prettier --check "src/**/*.{ts,js,json}" || {
              echo "‚ùå Code is not properly formatted"
              echo "üîß Run 'npx prettier --write \"src/**/*.{ts,js,json}\"' to fix formatting"
              exit 1
            }
            echo "‚úÖ Code formatting is correct"
          else
            echo "‚ö†Ô∏è Prettier not found, skipping format check"
          fi

  type-coverage:
    name: üéØ TypeScript Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üéØ Type coverage analysis
        run: |
          echo "üéØ Analyzing TypeScript type coverage..."

          # Install simpler type coverage tool
          npm install -g type-coverage

          # Generate type coverage report
          npx type-coverage --detail > type-coverage-report.txt || echo "‚ö†Ô∏è Type coverage analysis completed"

          # Extract coverage percentage and create simple report
          if [[ -f type-coverage-report.txt ]]; then
            COVERAGE=$(grep -o '[0-9]\+\.[0-9]\+%' type-coverage-report.txt | head -1)
            echo "üìä Type coverage: $COVERAGE"

            # Create HTML report directory with simple report
            mkdir -p type-coverage-report
            echo "<h1>Type Coverage Report</h1><p>Coverage: $COVERAGE</p>" > type-coverage-report/index.html
            echo "<pre>$(cat type-coverage-report.txt)</pre>" >> type-coverage-report/index.html

            echo "type-coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "üìä Type coverage: N/A"
            echo "type-coverage=N/A" >> $GITHUB_OUTPUT
          fi

      - name: üì§ Upload type coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-coverage-report
          path: type-coverage-report/
          retention-days: 30

  test-coverage:
    name: üß™ Test Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üß™ Run tests with coverage
        run: |
          echo "üß™ Running tests with coverage analysis..."
          npm run test:ci
        env:
          NODE_ENV: test

      - name: üìä Coverage summary
        run: |
          if [[ -f coverage/coverage-summary.json ]]; then
            echo "üìä Coverage Summary:"
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('üìà Lines:', total.lines.pct + '%');
              console.log('üåü Functions:', total.functions.pct + '%');
              console.log('üîÄ Branches:', total.branches.pct + '%');
              console.log('üìÑ Statements:', total.statements.pct + '%');

              // Check thresholds
              const thresholds = { lines: 80, functions: 80, branches: 70, statements: 80 };
              let failed = false;

              Object.keys(thresholds).forEach(key => {
                if (total[key].pct < thresholds[key]) {
                  console.log('‚ùå ' + key + ' coverage below threshold:',
                    total[key].pct + '% < ' + thresholds[key] + '%');
                  failed = true;
                }
              });

              if (failed) {
                console.log('‚ùå Coverage thresholds not met');
                process.exit(1);
              } else {
                console.log('‚úÖ All coverage thresholds met');
              }
            "
          else
            echo "‚ö†Ô∏è Coverage report not found"
          fi

      - name: üì§ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: üìä Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage
          flags: unittests
          name: codecov-${{ github.run_id }}

  code-metrics:
    name: üìà Code Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üìà Analyze code complexity
        run: |
          echo "üìà Analyzing code complexity..."

          # Install complexity analysis tools
          npm install -g jscpd

          # Generate complexity report using ESLint complexity rule
          echo "üîç Running complexity analysis..."
          npx eslint src/ --rule 'complexity: [2, 10]' --format json > complexity-report.json || \
            echo "‚ö†Ô∏è Some complexity issues found"

          # Simple complexity check
          echo "üìä Complexity Summary:"
          if [[ -f complexity-report.json ]]; then
            node -e "
              try {
                const report = require('./complexity-report.json');
                const complexityIssues = report.filter(file =>
                  file.messages.some(msg => msg.ruleId === 'complexity')
                );

                console.log('üìä Files analyzed:', report.length);
                console.log('‚ö†Ô∏è Files with complexity issues:', complexityIssues.length);

                if (complexityIssues.length > 0) {
                  console.log('‚ö†Ô∏è Consider refactoring high complexity functions');
                } else {
                  console.log('‚úÖ No high complexity functions found');
                }
              } catch (e) {
                console.log('‚úÖ Complexity analysis completed');
              }
            "
          else
            echo "‚úÖ No complexity report generated - likely no complexity issues"
          fi

      - name: üìã Duplicate code detection
        run: |
          echo "üìã Detecting duplicate code..."
          jscpd src/ --reporters json --output ./jscpd-report.json || echo "‚ö†Ô∏è jscpd analysis completed with warnings"

          if [[ -f jscpd-report.json ]]; then
            echo "üìä Duplication Summary:"
            node -e "
              try {
                const report = require('./jscpd-report.json');
                const duplicates = report.duplicates || [];
                console.log('üìä Total duplicates found:', duplicates.length);

                if (duplicates.length > 10) {
                  console.log('‚ö†Ô∏è High number of duplicates found - consider refactoring');
                } else if (duplicates.length > 0) {
                  console.log('‚ÑπÔ∏è Some duplicates found - review for potential refactoring opportunities');
                } else {
                  console.log('‚úÖ No significant code duplication detected');
                }
              } catch (e) {
                console.log('‚ö†Ô∏è Could not parse duplication report');
              }
            "
          fi

      - name: üì§ Upload code metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics
          path: |
            complexity-report.json
            jscpd-report.json
          retention-days: 30

  dependency-analysis:
    name: üì¶ Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üì¶ Dependency tree analysis
        run: |
          echo "üì¶ Analyzing dependency tree..."

          # Check for outdated dependencies
          echo "üîç Checking for outdated dependencies..."
          npm outdated --json > outdated-deps.json || echo "‚úÖ All dependencies are up to date"

          if [[ -s outdated-deps.json ]]; then
            echo "üìä Outdated Dependencies Summary:"
            node -e "
              try {
                const outdated = require('./outdated-deps.json');
                const deps = Object.keys(outdated);
                console.log('üìä Outdated dependencies:', deps.length);

                deps.forEach(dep => {
                  const info = outdated[dep];
                  console.log(\`  - \${dep}: \${info.current} ‚Üí \${info.latest}\`);
                });

                if (deps.length > 20) {
                  console.log('‚ö†Ô∏è Many outdated dependencies - consider updating');
                }
              } catch (e) {
                console.log('‚úÖ All dependencies are up to date');
              }
            "
          fi

      - name: üìà Bundle size analysis
        run: |
          echo "üìà Analyzing bundle size..."

          # Build the project
          npm run build

          # Analyze bundle size
          echo "üìä Built file sizes:"
          du -sh dist/* || echo "‚ö†Ô∏è Could not analyze dist directory"

          # Check for large files
          find dist -type f -size +1M -exec echo "‚ö†Ô∏è Large file found: {} ($(du -h {} | cut -f1))" \;

      - name: üîç Unused dependencies check
        run: |
          echo "üîç Checking for unused dependencies..."

          # Install depcheck
          npm install -g depcheck

          # Run depcheck
          depcheck --json > depcheck-report.json || echo "‚úÖ No unused dependencies found"

          if [[ -f depcheck-report.json ]]; then
            echo "üìä Dependency Check Summary:"
            node -e "
              try {
                const report = require('./depcheck-report.json');

                if (report.dependencies && report.dependencies.length > 0) {
                  console.log('‚ö†Ô∏è Unused dependencies:', report.dependencies.join(', '));
                } else {
                  console.log('‚úÖ No unused dependencies found');
                }

                if (report.devDependencies && report.devDependencies.length > 0) {
                  console.log('‚ö†Ô∏è Unused devDependencies:', report.devDependencies.join(', '));
                } else {
                  console.log('‚úÖ No unused devDependencies found');
                }
              } catch (e) {
                console.log('‚úÖ Dependency check completed');
              }
            "
          fi

      - name: üì§ Upload dependency analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: |
            outdated-deps.json
            depcheck-report.json
          retention-days: 30

  quality-gate:
    name: üö™ Quality Gate
    runs-on: ubuntu-latest
    needs: [linting, type-coverage, test-coverage, code-metrics, dependency-analysis]
    if: always()
    timeout-minutes: 5

    steps:
      - name: üö™ Quality gate evaluation
        run: |
          echo "## üìè Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check all job results
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each job result
          if [[ "$LINTING_RESULT" == "success" ]]; then
            echo "| Linting & Formatting | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Linting & Formatting | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$TYPE_COVERAGE_RESULT" == "success" ]]; then
            echo "| Type Coverage | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Type Coverage | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$TEST_COVERAGE_RESULT" == "success" ]]; then
            echo "| Test Coverage | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Test Coverage | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$CODE_METRICS_RESULT" == "success" ]]; then
            echo "| Code Metrics | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Metrics | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$DEPENDENCY_ANALYSIS_RESULT" == "success" ]]; then
            echo "| Dependency Analysis | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dependency Analysis | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate overall quality score
          PASSED=0
          TOTAL=5

          if [[ "$LINTING_RESULT" == "success" ]]; then PASSED=$((PASSED + 1)); fi
          if [[ "$TYPE_COVERAGE_RESULT" == "success" ]]; then PASSED=$((PASSED + 1)); fi
          if [[ "$TEST_COVERAGE_RESULT" == "success" ]]; then PASSED=$((PASSED + 1)); fi
          if [[ "$CODE_METRICS_RESULT" == "success" ]]; then PASSED=$((PASSED + 1)); fi
          if [[ "$DEPENDENCY_ANALYSIS_RESULT" == "success" ]]; then PASSED=$((PASSED + 1)); fi

          SCORE=$((PASSED * 100 / TOTAL))

          echo "### üìä Quality Score: $SCORE% ($PASSED/$TOTAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ $SCORE -ge 80 ]]; then
            echo "### ‚úÖ Quality Gate: **PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality meets the required standards!" >> $GITHUB_STEP_SUMMARY
            exit 0
          elif [[ $SCORE -ge 60 ]]; then
            echo "### ‚ö†Ô∏è Quality Gate: **WARNING**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality has some issues that should be addressed." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### ‚ùå Quality Gate: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Code quality is below acceptable standards." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        env:
          LINTING_RESULT: ${{ needs.linting.result }}
          TYPE_COVERAGE_RESULT: ${{ needs.type-coverage.result }}
          TEST_COVERAGE_RESULT: ${{ needs.test-coverage.result }}
          CODE_METRICS_RESULT: ${{ needs.code-metrics.result }}
          DEPENDENCY_ANALYSIS_RESULT: ${{ needs.dependency-analysis.result }}
